generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & CORE USER (Better Auth)
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sessions              Session[]
  accounts              Account[]
  applications          Application[]
  hackathonParticipants HackathonParticipant[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

// ============================================================================
// APPLICATION SYSTEM (beaverhacks.org)
// ============================================================================

enum ApplicationStatus {
  APPLIED
  ACCEPTED
  REJECTED
  WAITLISTED
  CHECKED_IN
}

enum ShirtSize {
  XS
  S
  M
  L
  XL
  XXL
}

model Application {
  id             String            @id @default(cuid())
  createdAt      DateTime          @default(now())
  userId         String
  hackathonId    String
  name           String
  university     String
  graduationYear Int
  shirtSize      ShirtSize
  resumePath     String
  status         ApplicationStatus @default(APPLIED)

  // Relations
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)

  @@unique([userId, hackathonId])
  @@map("application")
}

// ============================================================================
// HACKATHON PARTICIPATION SYSTEM (judge.beaverhacks.org)
// ============================================================================

model Hackathon {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  applications Application[]
  participants HackathonParticipant[]
  teams        Team[]
  tracks       Track[]
  submissions  Submission[]
  sponsors     Sponsor[]
  judges       Judge[]

  @@map("hackathon")
}

model HackathonParticipant {
  id          String   @id @default(cuid())
  userId      String
  hackathonId String
  joinedAt    DateTime @default(now())

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  hackathon  Hackathon  @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  teamMember TeamMember?

  @@unique([userId, hackathonId])
  @@map("hackathon_participant")
}

model Team {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  lookingForTeammates Boolean  @default(false)
  contact             String?
  creatorId           String
  hackathonId         String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  hackathon  Hackathon    @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  members    TeamMember[]
  submission Submission?
  drafts     Draft?
  invites    Invite[]

  @@map("team")
}

model TeamMember {
  id            String   @id @default(cuid())
  teamId        String
  participantId String   @unique
  joinedAt      DateTime @default(now())

  // Relations
  team        Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  participant HackathonParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@map("team_member")
}

model Invite {
  id        String    @id @default(cuid())
  code      String    @unique @default(cuid())
  teamId    String
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("invite")
}

model Draft {
  id          String   @id @default(cuid())
  teamId      String   @unique
  hackathonId String
  name        String?
  tagline     String?
  description String?
  githubUrl   String?
  videoUrl    String?
  images      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tracks      Track[]

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("draft")
}

model Submission {
  id          String   @id @default(cuid())
  teamId      String   @unique
  hackathonId String
  name        String
  tagline     String   @default("")
  description String   @default("")
  githubUrl   String   @default("")
  videoUrl    String   @default("")
  images      String[] @default([])
  tableNumber Int?     // Auto-assigned sequentially starting from 1
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  team      Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)
  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  tracks    Track[]

  // Multi-round judging
  roundAssignments RoundJudgeAssignment[]
  triageScores     TriageScore[]
  scores           Score[]
  rankedVotes      RankedVote[]
  advancements     RoundAdvancement[]
  trackWins        TrackWinner[]

  @@map("submission")
}

model Track {
  id          String   @id @default(cuid())
  name        String
  description String
  hackathonId String
  prize       String?
  sponsorId   String?
  createdAt   DateTime @default(now())

  // Relations
  hackathon        Hackathon              @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  sponsor          Sponsor?               @relation(fields: [sponsorId], references: [id])
  drafts           Draft[]
  submissions      Submission[]
  rubric           Rubric?
  judgingPlan      JudgingPlan?
  judgeAssignments JudgeTrackAssignment[]
  winners          TrackWinner[]

  @@map("track")
}

model Rubric {
  id      String @id @default(cuid())
  name    String
  trackId String @unique

  // Relations
  track    Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)
  criteria RubricCriteria[]
  rounds   JudgingRound[]

  @@map("rubric")
}

model RubricCriteria {
  id          String  @id @default(cuid())
  rubricId    String
  name        String
  description String?
  weight      Float
  maxScore    Int

  // Relations
  rubric Rubric @relation(fields: [rubricId], references: [id], onDelete: Cascade)

  @@map("rubric_criteria")
}

model Sponsor {
  id          String   @id @default(cuid())
  name        String
  description String?
  logoUrl     String
  hackathonId String
  websiteUrl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  tracks    Track[]

  @@map("sponsor")
}

// ============================================================================
// MULTI-ROUND JUDGING SYSTEM
// ============================================================================

enum JudgingRoundType {
  TRIAGE
  RUBRIC
  RANKED
}

model Judge {
  id          String   @id @default(cuid())
  hackathonId String
  name        String
  email       String
  createdAt   DateTime @default(now())

  // Relations
  hackathon        Hackathon              @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  trackAssignments JudgeTrackAssignment[]
  roundAssignments RoundJudgeAssignment[]
  triageScores     TriageScore[]
  scores           Score[]
  rankedVotes      RankedVote[]

  @@unique([hackathonId, email])
  @@map("judge")
}

// Assigns judges to tracks they can judge
model JudgeTrackAssignment {
  id      String @id @default(cuid())
  judgeId String
  trackId String

  // Relations
  judge Judge @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  track Track @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([judgeId, trackId])
  @@map("judge_track_assignment")
}

// Judging plan for a track (defines rounds)
model JudgingPlan {
  id      String @id @default(cuid())
  trackId String @unique

  // Relations
  track  Track          @relation(fields: [trackId], references: [id], onDelete: Cascade)
  rounds JudgingRound[]

  @@map("judging_plan")
}

// A single round in a judging plan
model JudgingRound {
  id                String           @id @default(cuid())
  planId            String
  roundNumber       Int
  type              JudgingRoundType
  advanceCount      Int?
  advancePercent    Float?
  judgesPerProject  Int              @default(3)
  minutesPerProject Int              @default(5)
  rubricId          String?
  rankedSlots       Int?
  isActive          Boolean          @default(false)
  isComplete        Boolean          @default(false)
  startedAt         DateTime?        // Set when round is started via admin

  // Relations
  plan             JudgingPlan            @relation(fields: [planId], references: [id], onDelete: Cascade)
  rubric           Rubric?                @relation(fields: [rubricId], references: [id])
  judgeAssignments RoundJudgeAssignment[]
  triageScores     TriageScore[]
  rankedVotes      RankedVote[]
  advancements     RoundAdvancement[]

  @@map("judging_round")
}

// Per-round assignment of judge to submission
model RoundJudgeAssignment {
  id            String  @id @default(cuid())
  roundId       String
  judgeId       String
  submissionId  String
  completed     Boolean @default(false)
  skippedReason String? // "team_no_show", "team_not_ready", "technical", "other"
  skippedNote   String? // Optional note if reason is "other"
  notes         String? // Private judge notes

  // Relations
  round      JudgingRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  judge      Judge        @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  submission Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([roundId, judgeId, submissionId])
  @@map("round_judge_assignment")
}

// Triage round scores (1-5 stars)
model TriageScore {
  id           String @id @default(cuid())
  roundId      String
  judgeId      String
  submissionId String
  stars        Int

  // Relations
  round      JudgingRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  judge      Judge        @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  submission Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([roundId, judgeId, submissionId])
  @@map("triage_score")
}

// Rubric round scores (per criteria)
model Score {
  id           String  @id @default(cuid())
  roundId      String
  judgeId      String
  submissionId String
  criteriaId   String
  value        Int
  notes        String?

  // Relations
  judge      Judge      @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([roundId, judgeId, submissionId, criteriaId])
  @@map("score")
}

// Ranked round votes
model RankedVote {
  id           String @id @default(cuid())
  roundId      String
  judgeId      String
  submissionId String
  rank         Int

  // Relations
  round      JudgingRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  judge      Judge        @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  submission Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([roundId, judgeId, submissionId])
  @@map("ranked_vote")
}

// Tracks which submissions advance from each round
model RoundAdvancement {
  id           String  @id @default(cuid())
  roundId      String
  submissionId String
  toRoundId    String?
  rank         Int

  // Relations
  round      JudgingRound @relation(fields: [roundId], references: [id], onDelete: Cascade)
  submission Submission   @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([roundId, submissionId])
  @@map("round_advancement")
}

// Final winners per track
model TrackWinner {
  id           String @id @default(cuid())
  trackId      String
  submissionId String
  place        Int

  // Relations
  track      Track      @relation(fields: [trackId], references: [id], onDelete: Cascade)
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  @@unique([trackId, submissionId])
  @@map("track_winner")
}
