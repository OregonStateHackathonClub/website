generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// AUTHENTICATION & CORE USER (Better Auth)
// ============================================================================

enum UserRole {
  USER
  ADMIN
}

model User {
  id            String   @id @default(cuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  sessions              Session[]
  accounts              Account[]
  application           Application?
  hackathonParticipants HackathonParticipant[]

  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String    @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt

  @@map("verification")
}

// ============================================================================
// APPLICATION SYSTEM (beaverhacks.org)
// ============================================================================

enum ApplicationStatus {
  APPLIED
  CHECKED_IN
}

enum ShirtSize {
  XS
  S
  M
  L
  XL
  XXL
}

model Application {
  id             String            @id @default(cuid())
  createdAt      DateTime          @default(now())
  userId         String            @unique
  university     String
  graduationYear Int
  shirtSize      ShirtSize
  resumePath     String
  status         ApplicationStatus @default(APPLIED)
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("application")
}

// ============================================================================
// HACKATHON PARTICIPATION SYSTEM (judge.beaverhacks.org)
// ============================================================================

model Hackathon {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  participants HackathonParticipant[]
  teams        Team[]
  tracks       Track[]
  submissions  Submission[]
  judges       JudgeAssignment[]

  @@map("hackathon")
}

// Join table: User ↔ Hackathon (tracks who's participating in which hackathons)
model HackathonParticipant {
  id          String   @id @default(cuid())
  userId      String
  hackathonId String
  joinedAt    DateTime @default(now())

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  hackathon  Hackathon   @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  teamMember TeamMember?
  judge      Judge?

  @@unique([userId, hackathonId])
  @@map("hackathon_participant")
}

model Team {
  id                  String   @id @default(cuid())
  name                String
  description         String?
  lookingForTeammates Boolean  @default(false)
  contact             String?
  creatorId           String // The user who created the team
  hackathonId         String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  hackathon  Hackathon    @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  members    TeamMember[]
  submission Submission?
  drafts     Draft?
  invites    Invite[]

  @@map("team")
}

// Join table: HackathonParticipant ↔ Team (one participant per hackathon can be on one team)
model TeamMember {
  id            String   @id @default(cuid())
  teamId        String
  participantId String   @unique // One participant can only be on one team per hackathon
  joinedAt      DateTime @default(now())

  // Relations
  team        Team                 @relation(fields: [teamId], references: [id], onDelete: Cascade)
  participant HackathonParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@map("team_member")
}

model Invite {
  id        String    @id @default(cuid())
  code      String    @unique @default(cuid())
  teamId    String
  createdAt DateTime  @default(now())
  expiresAt DateTime?

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("invite")
}

model Draft {
  id          String   @id @default(cuid())
  teamId      String   @unique
  hackathonId String
  name        String?
  tagline     String?
  description String?
  githubUrl   String?
  videoUrl    String?
  images      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tracks      Track[]

  // Relations
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@map("draft")
}

model Submission {
  id          String   @id @default(cuid())
  teamId      String   @unique
  hackathonId String
  name        String
  tagline     String   @default("")
  description String   @default("")
  githubUrl   String   @default("")
  videoUrl    String   @default("")
  images      String[] @default([])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  team             Team              @relation(fields: [teamId], references: [id], onDelete: Cascade)
  hackathon        Hackathon         @relation(fields: [hackathonId], references: [id], onDelete: Cascade)
  scores           Score[]
  tracks           Track[]
  grade            RubricGrade[]

  @@map("submission")
}

model Track {
  id          String   @id @default(cuid())
  name        String
  description String
  hackathonId String
  prize       String?
  createdAt   DateTime @default(now())
  drafts      Draft[]
  submissions Submission[]
  rubrics    Rubric?

  // Relations
  hackathon        Hackathon         @relation(fields: [hackathonId], references: [id], onDelete: Cascade)

  @@map("track")
}

model Rubric{
  id          String   @id @default(cuid())
  name        String
  trackId     String   @unique

  // Relations
  track       Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  criteria    RubricCriteria[]

  @@map("rubric")
}

model RubricCriteria{
  id          String   @id @default(cuid())
  rubricId    String   @unique
  name        String
  weight      Float
  maxScore    Int

  // Relations
  rubric      Rubric   @relation(fields: [rubricId], references: [id], onDelete: Cascade)
  grade       RubricGrade[]

  @@map("rubric_criteria")
}

model RubricGrade{
  id          String   @id @default(cuid())
  submissionId String
  rubricCriteriaId String
  score        Float

  // Relations
  submission  Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  rubricCriteria  RubricCriteria @relation(fields: [rubricCriteriaId], references: [id], onDelete: Cascade)


  @@map("rubric_grade")
}


// ============================================================================
// JUDGE SYSTEM (judge.beaverhacks.org)
// ============================================================================

enum JudgeRole {
  JUDGE
  MANAGER
}

model Judge {
  id                       String    @id @default(cuid())
  name                     String
  email                    String    @unique
  magicLinkToken           String?   @unique
  hackathon_participant_id String    @unique
  role                     JudgeRole @default(JUDGE)

  // Relations
  hackathon_participant HackathonParticipant @relation(fields: [hackathon_participant_id], references: [id], onDelete: Cascade)
  assignments           JudgeAssignment[]
  scores                Score[]

  @@map("judge")
}

// Join table: Judge ↔ Hackathon (judges can be assigned to multiple hackathons)
model JudgeAssignment {
  id          String   @id @default(cuid())
  judgeId     String
  hackathonId String
  assignedAt  DateTime @default(now())

  // Relations
  judge     Judge     @relation(fields: [judgeId], references: [id], onDelete: Cascade)
  hackathon Hackathon @relation(fields: [hackathonId], references: [id], onDelete: Cascade)

  @@unique([judgeId, hackathonId])
  @@map("judge_assignment")
}

model Score {
  id           String   @id @default(cuid())
  submissionId String
  judgeId      String
  rubricScores Json     @default("{}")
  totalScore   Int      @default(0)
  comments     String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  submission Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  judge      Judge      @relation(fields: [judgeId], references: [id], onDelete: Cascade)

  @@unique([submissionId, judgeId])
  @@map("score")
}
